<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName apps.equalexperts.ai
    ServerAdmin webmaster@equalexperts.ai

    # Enable proxy modules
    ProxyPreserveHost On

    # Redirect root to main Equal Experts site
    <Location "/">
        # Don't redirect if path starts with known app paths
        RewriteEngine On
        RewriteCond %{REQUEST_URI} !^/aithinktank
        RewriteCond %{REQUEST_URI} !^/eesweetspot
        RewriteCond %{REQUEST_URI} !^/thinktank
        RewriteCond %{REQUEST_URI} !^/survey
        RewriteCond %{REQUEST_URI} !^/awdio
        RewriteRule ^/$ https://equalexperts.ai [R=302,L]
    </Location>

    # Think Tank API - Docker container on port 8080
    # ElevenLabs webhook endpoint (no basic auth - uses API key)
    ProxyPass /thinktank/api http://localhost:8080
    ProxyPassReverse /thinktank/api http://localhost:8080

    <LocationMatch "^/thinktank/api">
        # Disable auth for API endpoints
        Satisfy Any
        Allow from all

        # Security headers
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
    </LocationMatch>

    # Think Tank Frontend - Docker container on port 3001
    ProxyPass /thinktank http://localhost:3001/
    ProxyPassReverse /thinktank http://localhost:3001/

    <LocationMatch "^/thinktank(?!/api)">
        # Basic HTTP authentication for frontend only
        AuthType Basic
        AuthName "EE Think Tank Access"
        AuthUserFile /etc/apache2/.htpasswd-thinktank
        Require valid-user

        # Security headers
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
        RequestHeader set X-Forwarded-Prefix "/thinktank"

        # Inject base tag for relative URL resolution
        AddOutputFilterByType SUBSTITUTE text/html
        Substitute "s|<head>|<head><base href=\"/thinktank/\">|i"
    </LocationMatch>

    # Survey API - Docker container on port 8080
    # ElevenLabs webhook endpoint (no basic auth - uses API key)
    ProxyPass /survey/api http://localhost:8080
    ProxyPassReverse /survey/api http://localhost:8080

    <LocationMatch "^/survey/api">
        # Disable auth for API endpoints (uses API key)
        Satisfy Any
        Allow from all

        # Security headers
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
    </LocationMatch>

    # Survey Admin Frontend - Docker container on port 3004 (password protected)
    ProxyPass /survey/admin http://localhost:3004/
    ProxyPassReverse /survey/admin http://localhost:3004/

    <LocationMatch "^/survey/admin">
        # Basic HTTP authentication for admin UI
        AuthType Basic
        AuthName "Survey Admin Access"
        AuthUserFile /etc/apache2/.htpasswd-survey
        Require valid-user

        # Security headers
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
        RequestHeader set X-Forwarded-Prefix "/survey/admin"

        # Inject base tag for relative URL resolution
        AddOutputFilterByType SUBSTITUTE text/html
        Substitute "s|<head>|<head><base href=\"/survey/admin/\">|i"
    </LocationMatch>

    # Survey Written Form - Docker container on port 3006 (no auth)
    ProxyPass /survey/form http://localhost:3006/
    ProxyPassReverse /survey/form http://localhost:3006/

    <LocationMatch "^/survey/form">
        # No authentication for public form
        Satisfy Any
        Allow from all

        # Security headers
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
        RequestHeader set X-Forwarded-Prefix "/survey/form"

        # Inject base tag for relative URL resolution
        AddOutputFilterByType SUBSTITUTE text/html
        Substitute "s|<head>|<head><base href=\"/survey/form/\">|i"
    </LocationMatch>

    # Survey Public Landing Page - Docker container on port 3005 (no auth)
    ProxyPass /survey http://localhost:3005/
    ProxyPassReverse /survey http://localhost:3005/

    <LocationMatch "^/survey(?!/(api|admin|form))">
        # No authentication for public survey page
        Satisfy Any
        Allow from all

        # Security headers
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
        RequestHeader set X-Forwarded-Prefix "/survey"

        # Inject base tag for relative URL resolution
        AddOutputFilterByType SUBSTITUTE text/html
        Substitute "s|<head>|<head><base href=\"/survey/\">|i"
    </LocationMatch>

    # Awdio - Voice-Driven Podcasts on port 3003
    # NOTE: Awdio uses OAuth/JWT authentication instead of Basic Auth

    # WebSocket proxy for Q&A to backend - MUST come before general /awdio proxy
    ProxyPassMatch ^/awdio/ws/(.*)$ ws://localhost:8002/ws/$1
    ProxyPassReverse /awdio/ws/ ws://localhost:8002/ws/

    # API proxy to backend
    ProxyPass /awdio/api http://localhost:8002/api
    ProxyPassReverse /awdio/api http://localhost:8002/api

    # HMR WebSocket for Next.js dev
    ProxyPass /awdio/_next/webpack-hmr ws://localhost:3003/awdio/_next/webpack-hmr
    ProxyPassReverse /awdio/_next/webpack-hmr ws://localhost:3003/awdio/_next/webpack-hmr

    # Frontend - general catch-all (must be last)
    ProxyPass /awdio http://localhost:3003/awdio
    ProxyPassReverse /awdio http://localhost:3003/awdio

    <Location /awdio>
        # Security headers
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
        RequestHeader set X-Forwarded-Prefix "/awdio"
    </Location>

    # Allow embed routes without authentication (for iframe embedding)
    <Location /awdio/embed>
        Header set X-Frame-Options "ALLOWALL"
        Header set Content-Security-Policy "frame-ancestors *"
    </Location>

    # CORS headers for embed API
    <Location /awdio/api/v1/embed>
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type"
    </Location>

    # AI Think Tank - Docker container on port 3001 (legacy path)
    ProxyPass /aithinktank http://localhost:3001/
    ProxyPassReverse /aithinktank http://localhost:3001/

    <Location /aithinktank>
        # Basic HTTP authentication
        AuthType Basic
        AuthName "AI Think Tank Access"
        AuthUserFile /etc/apache2/.htpasswd-aithinktank
        Require valid-user

        # Security headers
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
        RequestHeader set X-Forwarded-Prefix "/aithinktank"

        # Inject base tag for relative URL resolution
        AddOutputFilterByType SUBSTITUTE text/html
        Substitute "s|<head>|<head><base href=\"/aithinktank/\">|i"
    </Location>

    # EESweetSpot - Research Platform on port 3333
    # Static files: NO path stripping - keep /eesweetspot prefix
    ProxyPass /eesweetspot/static http://localhost:3333/eesweetspot/static
    ProxyPassReverse /eesweetspot/static http://localhost:3333/eesweetspot/static

    # Dynamic content: WITH path stripping
    ProxyPass /eesweetspot/ http://localhost:3333/
    ProxyPassReverse /eesweetspot/ http://localhost:3333/
    ProxyPass /eesweetspot http://localhost:3333
    ProxyPassReverse /eesweetspot http://localhost:3333

    <Location /eesweetspot>
        # Security headers
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s

        # WebSocket support
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} =websocket [NC]
        RewriteRule /eesweetspot/(.*) ws://localhost:3333/$1 [P,L]
    </Location>

    # SSL Configuration (LetsEncrypt)
    SSLCertificateFile /etc/letsencrypt/live/apps.equalexperts.ai/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/apps.equalexperts.ai/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/apps.equalexperts.ai_error.log
    CustomLog ${APACHE_LOG_DIR}/apps.equalexperts.ai_access.log combined
</VirtualHost>
</IfModule>
